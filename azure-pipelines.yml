trigger:
  branches:
    include:
      - main

variables:
  azureSubscription: 'acr-docker-connection'
  acrLoginServer: 'bratvaa.azurecr.io'
  imageName: 'nodejs-app'

stages:
  - stage: Build
    jobs:
      - job: BuildAndPush
        pool:
          name: 'bratva'
         
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: 'Install Node.js'

          - script: |
              npm install
              npm run build
            displayName: 'Build nodejs-app'
            workingDirectory: node-app


          - task: Docker@2
            inputs:
              command: buildAndPush
              repository: $(acrLoginServer)/$(imageName)
              dockerfile: Dockerfile
              containerRegistry: $(azureSubscription)
              tags: |
                $(Build.BuildId)
            displayName: 'Build and Push Docker image to ACR'
